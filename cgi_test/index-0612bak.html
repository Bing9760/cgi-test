<!doctype html>
<!doctype html>
<html>
<script>

function check(val)
{ 
	if (val<10)
	{ 
  		return("0"+val); 
 	}else{ 
  		return(val); 
 	} 
} 

function show()
{ 
	var date = new Date();
	var now = ""; 
	now = date.getFullYear()+"年"+ check((date.getMonth()+1))+"月"+check(date.getDate())+"日  "+check(date.getHours())+"："+check(date.getMinutes())+"："+check(date.getSeconds()); 
	document.getElementById("nowDiv").innerHTML = now;
	setTimeout("show()",1000); 
}
	

var clickEvent = function changeImg(obj){
	var reg=new RegExp(".*(?:\/)","g");
	alert(obj.src.replace(reg,""));
	if(obj.src.replace(reg,"")=="off.jpg"){
		  obj.src = "image/on.jpg";
	  }else{
		  obj.src = "image/off.jpg";  
	  }
	alert(obj.src.replace(reg,""));
	sender(obj);
	}

function doAjaxCall(the_request){
        var request=null;
        if(window.XMLHttpRequest){
            request=new XMLHttpRequest();
        }else if(window.ActiveXObject){
            request=new ActiveXObject("Microsoft.XMLHTTP");
        }
        if(request){
            request.open("GET",the_request,true);
            request.onreadystatechange = function(){
                if(request.readyState === 4){
                    if (request.status == 200 || request.status == 0){
					var roomArray = new Array(1011,1012,1021,1022,
											  1031,1032,1041,1042,
											  1051,1052,1061,1062);
					var tail = new RegExp("[0-9]$");
					var i=0,len=roomArray.length;
					
					for(;i<len;i++){
						var reg = new RegExp("EF+"+roomArray[i]+"+[0-9]{4}");
						var lightStatue = tail.exec(reg.exec(request.responseText));
						var roomChg = document.getElementById(roomArray[i]);
						if(lightStatue == 1){
							roomChg.src = "image/on.jpg";
						}else{
							roomChg.src = "image/off.jpg";
						}
					}
                    }
                }
            }
            request.send(null);
        }else{
            alert("error");
        }
		setTimeout("doAjaxCall('write.ini')",1000); 
}  

	 /*
 *创建异步访问对象
 */
function createXHR() 
{
    var xhr;
    try 
    {
        xhr = new ActiveXObject("Msxml2.XMLHTTP");
    } 
    catch (e) 
    {
        try 
        {
            xhr = new ActiveXObject("Microsoft.XMLHTTP");
        }
        catch(E) 
        {
            xhr = false;
        }
    }
    if (!xhr && typeof XMLHttpRequest != 'undefined') 
    {
        xhr = new XMLHttpRequest();
    }
    return xhr;
}

/*
 *异步访问提交处理
 */
function sender(obj) 
{
    xhr = createXHR();

    if(xhr)
    {
		var reg=new RegExp(".*(?:\/)","g");
		
		alert(obj.id+obj.src.replace(reg,""));		
		
        xhr.onreadystatechange=callbackFunction;
    	
		if(obj.src.replace(reg,"")=="off.jpg"){
        //test.cgi后面跟个cur_time参数是为了防止Ajax页面缓存
        xhr.open("GET", "/cgi-bin/main.cgi?cur_time=" + new Date().getTime()+"EF"+obj.id+"0000");
			alert("EF"+obj.id+"0000");
		}else if(obj.src.replace(reg,"")=="on.jpg"){
		//test.cgi后面跟个cur_time参数是为了防止Ajax页面缓存
        xhr.open("GET", "/cgi-bin/main.cgi?cur_time=" + new Date().getTime()+"EF"+obj.id+"0001");
			alert("EF"+obj.id+"0001");
		}else{
			alert("error!1");
		}
    		
        xhr.send();
    }
    else
    {
        //XMLHttpRequest对象创建失败
        alert("浏览器不支持，请更换浏览器！");
    }
}

/*
 *异步回调函数处理
 */
function callbackFunction()
{
    if (xhr.readyState == 4) 
    {
		
        if (xhr.status == 200) 
        {
            var returnValue = xhr.responseText;

			alert(returnValue);
//            if(returnValue != null && returnValue.length > 0)
//            {
//                document.getElementById("current_time").innerHTML = returnValue;
//            }
//            else
//            {
//                alert("结果为空！");
//            }
        } 
        else 
        {
            alert("页面出现异常！");
        }
    }
}	
	
</script>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Cache-Control" content="no-cache">
<meta http-equiv="Expires" content="0">
<title>ZigBee 灯光控制系统</title>
<style>
	.header{
		font-weight: bold;
		text-align: center;
		font-size: 36px;
		color: aliceblue;
		font-family:"等线";
	}
	.copyright{
		font-size: 26px;
		color: aliceblue;
		font-weight: bold;
		font-family: "等线";
		text-align: center;
	}
	.div{
		width: 126px;
		height: 68px;
		border: 1px solid black;
		background-image: "url(image/off.jpg)";
	}
</style>
</head>

<body background="image/background.jpg" onLoad="show(),doAjaxCall('write.ini')">
<table width="800" border="0" align="center">
  <tbody>
    <tr>
      <td colspan="2" align="center" valign="top">
	    <h1 class="header">ZigBee灯光控制系统</h1>
	     <h2 align="right"><font color="aliceblue"><div id="nowDiv">date</div></font></h2>
		  <h3 align="center">点击按钮以刷新</h3>
		  <form action="cgi-bin/main1.cgi" method="post">
		  	<input type="submit" name="fresh" value="CGI test">
		  </form>
     
      </td>
          
    </tr>
    <tr>
    	<td width="80">123</td>
    	<td width="679"><table width="707" border="">
    	  <tbody>
    	    <tr>
    	      <td width="228">
 	          <p>Room-101</p>
  	          <p align="center"><img src="image/off.jpg" width="126" height="68" id="1011" onClick="clickEvent(this)"/></p>
   	          <p align="center"><img src="image/off.jpg" width="126" height="68" id="1012" onClick="clickEvent(this)"/></p></td>
   	          
    	      <td width="228">
 	          <p>Room-102</p>
  	          <p align="center"><img src="image/off.jpg" width="126" height="68" id="1021" onClick="clickEvent(this)"/></p>
   	          <p align="center"><img src="image/off.jpg" width="126" height="68" id="1022" onClick="clickEvent(this)"/></p></td>
   	          
    	      <td width="229">
 	          <p>Room-103</p>
  	          <p align="center"><img src="image/off.jpg" width="126" height="68" id="1031" onClick="clickEvent(this)"/></p>
   	          <p align="center"><img src="image/off.jpg" width="126" height="68" id="1032" onClick="clickEvent(this)"/></p></td>
  	      </tr>
    	    <tr>
    	      <td width="228">
 	          <p>Room-104</p>
  	          <p align="center"><img src="image/off.jpg" width="126" height="68" id="1041" onClick="clickEvent(this)"/></p>
   	          <p align="center"><img src="image/off.jpg" width="126" height="68" id="1042" onClick="clickEvent(this)"/></p></td>
   	          
    	      <td width="228">
 	          <p>Room-105</p>
  	          <p align="center"><img src="image/off.jpg" width="126" height="68" id="1051" onClick="clickEvent(this)"/></p>
   	          <p align="center"><img src="image/off.jpg" width="126" height="68" id="1052" onClick="clickEvent(this)"/></p></td>
   	          
    	      <td width="229">
 	          <p>Room-106</p>
  	          <p align="center"><img src="image/off.jpg" width="126" height="68" id="1061" onClick="clickEvent(this)"/></p>
   	          <p align="center"><img src="image/off.jpg" width="126" height="68" id="1062" onClick="clickEvent(this)"/></p></td>
  	      </tr>
  	    </tbody>
  	  </table></td>
    	
    </tr>
  </tbody>
</table>

<hr color="#663300" align="center" width="90%">
<p class="copyright">Copyright&copy;&nbsp;&nbsp;&nbsp;莆田学院—信息工程学院</p>
</body>
</html>
